# 🫀 ECG-SIGN 디지털 서명 시스템 - 프로젝트 보고서

---

## 1️⃣ Target (목표): 어떤 종류의 시스템을 설계했는가?

### 시스템 개요
**ECG(심전도) 파형의 형태학적 특징을 기반으로 개인을 식별하는 2차 인증 디지털 서명 시스템**

### 시스템 구성
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  하드웨어    │ ──▶ │ Android 앱  │ ──▶ │ Python 서버 │ ──▶ │   인증 결과  │
│ AD8232+     │ BT  │ 데이터 수집  │ TCP │ ECG 처리    │     │ 성공/실패   │
│ Arduino+    │     │ + 시각화    │     │ 파이프라인   │     │            │
│ HC-06       │     │             │     │             │     │            │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 핵심 기능
| 기능 | 설명 |
|------|------|
| **ECG 수집** | AD8232 센서로 500Hz 샘플링 |
| **R-peak 검출** | Pan-Tompkins 알고리즘 |
| **특징 추출** | 형태학적/시간/주파수/통계적 특징 37개+ |
| **서명 생성** | SHA-256 해시 기반 디지털 서명 |
| **인증** | 하이브리드 유사도 (코사인 70% + 유클리드 30%) |

---

## 2️⃣ Motivation (동기): 왜 이 시스템이 필요한가?

### 기존 생체 인증의 한계

| 인증 방식 | 장점 | 단점 |
|----------|------|------|
| **지문** | 보편화, 빠름 | ❌ 복제 가능, 손상 시 인식 불가 |
| **얼굴** | 비접촉 | ❌ 사진/영상으로 우회 가능 |
| **홍채** | 정확도 높음 | ❌ 고가 장비 필요 |
| **ECG** | ✅ 살아있는 사람만 가능, 위조 불가 | 전극 부착 필요 |

### ECG 인증의 핵심 장점
1. **생체 여부 자동 확인**: 심장이 뛰어야만 신호 발생 → 사망자/마네킹 불가
2. **복제 불가**: 실시간 생체 신호이므로 사진/녹화 우회 불가
3. **고유성**: P-QRS-T 파형의 형태와 간격이 개인마다 다름
4. **지속 인증**: 웨어러블 기기로 연속 인증 가능성

### 적용 시나리오
- 고보안 시설 출입 (금융, 군사, 의료)
- 2차 인증 (비밀번호 + ECG)
- 의료 환경 (환자 본인 확인)

---

## 3️⃣ Problem / Challenge (문제/과제)

### A. 프로젝트 정의 시 예상한 문제점

| 문제 | 설명 | 해결 방향 |
|------|------|----------|
| **ECG 신호 변동성** | 같은 사람도 측정 시점마다 신호가 다름 | 정규화 + 다중 특징 추출 |
| **노이즈** | 전원(60Hz), 근전도, 베이스라인 흔들림 | 디지털 필터링 파이프라인 |
| **실시간 처리** | 500Hz 데이터 스트리밍 | 버퍼링 + 비동기 처리 |
| **인증 정확도** | FAR/FRR 균형 | 하이브리드 유사도, 적응형 임계값 |

### B. 프로젝트 진행 중 겪은 실제 어려움

#### 🔴 어려움 1: 블루투스 데이터 전송 실패
**증상**: 
- Android 앱에서 "블루투스 연결 성공" 메시지는 뜸
- 하지만 ECG 데이터가 수신되지 않음

**원인 분석**:
```
휴대폰 ←── 블루투스 RF 연결 ──→ HC-06 ←── UART TX/RX ──✖ Arduino
           (이 부분은 정상)              (이 부분이 문제)
```
- HC-06 모듈의 **블루투스 RF 부분**과 **UART 시리얼 부분**은 독립적
- RF는 살아있어서 연결은 되지만, TX 핀 문제로 데이터 전송 안됨

#### 🔴 어려움 2: TX/RX 핀 연결 오류
**증상**: Arduino 시리얼 모니터에서는 데이터가 나오지만 블루투스로 안 감

**원인**: SoftwareSerial 핀 연결 혼동
```cpp
SoftwareSerial bluetooth(10, 11); // RX=10, TX=11
```
- HC-06 TX → Arduino 10번 (RX) 연결해야 함
- HC-06 RX → Arduino 11번 (TX) 연결해야 함
- **TX/RX가 교차 연결**되어야 하는데 잘못 연결

#### 🔴 어려움 3: HC-06 모듈 TX 핀 고장 의심
**증상**: 핀 연결을 올바르게 해도 데이터 전송 안됨

**분석**:
- 블루투스 연결은 됨 → RF 부분 정상
- 데이터가 안 넘어감 → UART TX 부분 고장 가능성

#### 🔴 어려움 4: 파이프라인 처리 실패 시 불완전한 등록
**증상**: 
- R-peak 검출 실패해도 `status: "success"` 반환
- 형태학적 특징 없이 단순 통계값으로 등록됨
- 이후 로그인 시 인증 정확도 저하

#### 🔴 어려움 5: R-peak 검출 부족
**증상**: "R-peak가 부족합니다. 검출: 2개/3개 필요"
- 6초 측정 중 심박이 느린 경우 R-peak 부족
- 노이즈로 인한 오검출

#### 🔴 어려움 6: 보드레이트 한계
**문제**: 9600 baud로는 500Hz 샘플링 데이터 전송 부족
```
필요 대역폭: 500 × 6바이트 = 3000바이트/초
9600 baud: 약 960바이트/초 (부족!)
```

---

## 4️⃣ Solution (해결책)

### 해결책 1: 블루투스 TX/RX 연결 문제
**해결 방법**: 핀 연결 교차 확인 및 테스트 코드 작성

```cpp
// 테스트 코드로 블루투스 전송 확인
void loop() {
  bluetooth.println("TEST");
  Serial.println("Sent TEST to Bluetooth");
  delay(1000);
}
```
- 휴대폰에서 "TEST" 수신되면 연결 정상
- 안 되면 TX/RX 선 교체

### 해결책 2: 모듈 고장 대응
**분석 프로세스**:
```
1. TX/RX 선 교체 시도
2. 테스트 코드로 확인
3. Arduino 시리얼 모니터 데이터 출력 확인
4. 위 모두 정상인데 전송 안되면 → 모듈 교체
```

### 해결책 3: 파이프라인 에러 처리 강화

**수정 전** (폴백으로 성공 처리):
```python
except Exception as e:
    return self._process_basic(ecg_data)  # 문제: 불완전 데이터로 등록
```

**수정 후** (명확한 에러 반환):
```python
except Exception as e:
    return {
        "status": "error",
        "message": f"파이프라인 처리 실패: {e}",
        "sample_count": len(ecg_data)
    }
```

**결과**: 파이프라인 실패 시 즉시 에러 응답 → 앱에서 재측정 안내

### 해결책 4: R-peak 검출 개선
1. **적응형 임계값**: 신호 강도에 따라 동적 조정
2. **RR 간격 제약**: 200ms~2000ms (30~300 BPM)
3. **원본 신호에서 정제**: 적분 신호 피크 → 원본에서 정확한 위치 재탐색

### 해결책 5: 신호 품질 검증 추가
```python
if quality_score < 60:
    return {
        "status": "low_quality",
        "message": f"신호 품질이 낮습니다 (점수: {quality_score})",
        "quality_score": quality_score
    }
```

### 해결책 6: Android 앱 에러 처리 UI
- 로그인/등록 실패 시 **원인별 팝업** 표시
- R-peak 부족, 신호 품질 낮음 등 구체적 안내
- 재측정 유도

---

## 5️⃣ Lessons Learned (배운 점)

### 기술적 배운 점

| 영역 | 배운 점 |
|------|---------|
| **신호 처리** | Butterworth 필터, Pan-Tompkins 알고리즘, FFT 실제 적용 |
| **하드웨어** | SoftwareSerial TX/RX 교차 연결의 중요성 |
| **블루투스** | RF 연결과 UART 시리얼은 독립적 (연결 ≠ 데이터 전송) |
| **에러 처리** | 폴백 처리의 위험성 (불완전한 성공보다 명확한 실패가 낫다) |
| **인증 시스템** | FAR/FRR 트레이드오프, 임계값 튜닝의 중요성 |

### 프로젝트 관리 배운 점

1. **단계별 검증의 중요성**
   - Arduino → 시리얼 모니터 확인
   - 블루투스 → 테스트 코드로 확인
   - 서버 → 로그 출력으로 확인
   - 각 단계를 독립적으로 테스트해야 문제 원인 파악 가능

2. **트러블슈팅 문서화**
   - 겪은 문제와 해결책을 기록
   - 같은 문제 재발 시 빠르게 대응 가능

3. **하드웨어 디버깅은 소프트웨어와 다름**
   - 코드가 맞아도 하드웨어 연결이 틀리면 작동 안함
   - 물리적 연결 상태(핀, 전원, 납땜)도 확인 필요

### 개선 필요 사항 인식
- [ ] 데이터베이스 연동 (현재 JSON 파일)
- [ ] 다중 템플릿 등록 (다양한 조건에서)
- [ ] 실시간 ECG 모니터링 웹 대시보드
- [ ] 암호화 강화

---

## 6️⃣ Role per Member (팀원별 역할)

> *(1인 프로젝트인 경우 역할별로 정리)*

### 전체 시스템 설계 및 구현

| 역할 | 담당 내용 | 비중 |
|------|----------|------|
| **하드웨어** | Arduino + AD8232 + HC-06 연결, 회로 구성 | 15% |
| **Android 앱** | Bluetooth/TCP 통신, UI 개발, 실시간 그래프 | 30% |
| **Python 서버** | TCP 서버, ECG 처리 파이프라인, 인증 로직 | 40% |
| **문서화** | 기술 문서, 트러블슈팅 가이드 작성 | 10% |
| **테스트** | 통합 테스트, 더미 데이터 생성기 구현 | 5% |

### 구현한 주요 모듈

```
📁 Hardware/
   └── main.ino              ← ECG 센서 읽기 + Bluetooth 전송

📁 Android_App/
   └── MainActivity.java     ← UI + 통신 + 그래프

📁 Signal_Processing/
   ├── ecg_server.py         ← TCP 서버
   └── ecg_processor/
       ├── preprocessing.py      ← 전처리 (필터링)
       ├── r_peak_detector.py    ← R-peak (Pan-Tompkins)
       ├── beat_processor.py     ← 비트 처리
       ├── feature_extractor.py  ← 특징 추출 (37개+)
       ├── signature_generator.py ← 서명 생성 (SHA-256)
       ├── pipeline.py           ← 통합 파이프라인
       └── auth_manager.py       ← 인증 관리
```

---

## 📊 프로젝트 성과 요약

| 항목 | 결과 |
|------|------|
| **샘플링 레이트** | 500 Hz |
| **수집 시간** | 6초 (3000 샘플) |
| **처리 시간** | < 1초 |
| **특징 수** | 37개+ (4개 도메인) |
| **인증 임계값** | 80% (하이브리드 유사도) |
| **서명 길이** | 64자 (SHA-256) |

---

## 🔑 핵심 메시지 (발표용)

> "ECG 파형에서 **Pan-Tompkins 알고리즘**으로 심박을 찾고, **30개 이상의 형태학적·시간·주파수·통계 특징**을 추출해 **SHA-256 해시**로 변환한 뒤, **하이브리드 유사도(코사인 70% + 유클리드 30%)**로 본인 여부를 판단하는 **2차 인증 시스템**"

---

## 📚 기술 스택

### Hardware
- **Arduino UNO**: ECG 센서 데이터 읽기 (10비트 ADC)
- **AD8232**: ECG 센서 모듈 (단일 리드)
- **HC-06**: Bluetooth 모듈 (SPP, 9600 baud)

### Android
- **언어**: Java
- **라이브러리**: MPAndroidChart, Bluetooth API, TCP Socket

### Python Server
- **언어**: Python 3
- **라이브러리**: NumPy, SciPy

### 알고리즘
- **Pan-Tompkins**: R-peak 검출 (1985 IEEE 논문)
- **Butterworth Filter**: 노이즈 제거
- **SHA-256**: 디지털 서명 해시
- **Hybrid Similarity**: 코사인 + 유클리드 유사도

---

*작성일: 2025-12-11*

