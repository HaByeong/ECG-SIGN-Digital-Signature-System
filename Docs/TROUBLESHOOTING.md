# ECG-SIGN 트러블슈팅 가이드

## 📋 목차
1. [파이프라인 관련 문제](#1-파이프라인-관련-문제)
2. [Bluetooth 연결 문제](#2-bluetooth-연결-문제)
3. [TCP 서버 연결 문제](#3-tcp-서버-연결-문제)
4. [ECG 데이터 품질 문제](#4-ecg-데이터-품질-문제)
5. [인증 실패 문제](#5-인증-실패-문제)
6. [Android 앱 문제](#6-android-앱-문제)

---

## 1. 파이프라인 관련 문제

### 🔴 문제: 파이프라인 처리 실패 시 불완전한 데이터로 등록됨

**증상**:
- 파이프라인 예외 발생 시에도 `status: "success"` 반환
- 형태학적 특징 없이 단순 통계값(평균, 분산 등)으로 등록됨
- 이후 로그인 시 인증 정확도 저하

**원인**:
- 기존 코드에서 파이프라인 실패 시 `_process_basic()` 폴백 함수가 성공으로 처리

**해결 (2025-12-05 적용)**:
```python
# ecg_server.py - 수정 전
except Exception as e:
    return self._process_basic(ecg_data)  # 폴백으로 성공 처리

# ecg_server.py - 수정 후
except Exception as e:
    print(f"[에러] 파이프라인 처리 실패: {e}")
    return {
        "status": "error",
        "message": f"파이프라인 처리 실패: {e}",
        "sample_count": len(ecg_data),
        "timestamp": datetime.now().isoformat()
    }
```

**결과**:
- 파이프라인 실패 시 즉시 에러 응답
- Android 앱에서 재측정 안내 팝업 표시
- 불완전한 데이터가 등록되지 않음

---

### 🔴 문제: R-peak 검출 부족 (insufficient_peaks)

**증상**:
```json
{
    "status": "insufficient_peaks",
    "message": "R-peak가 부족합니다. 검출: 2개/3개 필요"
}
```

**원인**:
- ECG 신호 품질 낮음
- 전극 접촉 불량
- 노이즈가 너무 많음
- 샘플링 시간 부족

**해결**:
1. **전극 상태 확인**
   - 전극 패드가 피부에 잘 붙어있는지 확인
   - 전극 젤이 말랐으면 새 전극 사용
   
2. **측정 환경 개선**
   - 움직이지 않고 편안하게 앉기
   - 전자기기와 거리 두기 (60Hz 노이즈 감소)
   
3. **측정 시간 늘리기**
   - 현재: 6초 (3000샘플)
   - 심박수가 느린 경우 더 긴 시간 필요

---

### 🔴 문제: 신호 품질 낮음 (low_quality)

**증상**:
```json
{
    "status": "low_quality",
    "message": "신호 품질이 낮습니다 (점수: 45.0)",
    "quality_score": 45.0
}
```

**원인**:
- SNR(신호 대 잡음비)이 낮음
- 신호 포화 (클리핑)
- 평탄 신호 (전극 분리)

**해결**:
| 품질 문제 | 해결 방법 |
|----------|----------|
| SNR 낮음 | 전극 재부착, 환경 노이즈 제거 |
| 클리핑 | ADC 범위 확인, 증폭 조정 |
| 평탄 신호 | 전극 연결 확인, 리드 오프 확인 |

**품질 점수 기준**:
- 60점 이상: 정상 처리
- 60점 미만: 재측정 필요

---

## 2. Bluetooth 연결 문제

### 🔴 문제: HC-06 장치를 찾을 수 없음

**증상**:
```
❌ HC-06 모듈을 찾을 수 없음.
휴대폰 블루투스 설정에서 페어링 확인
```

**원인**:
- 장치가 페어링되지 않음
- 장치 이름이 "HC-06"이 아님
- HC-06 전원이 꺼져 있음

**해결**:
1. **페어링 확인**
   ```
   Android 설정 → 블루투스 → 페어링된 장치 확인
   ```

2. **장치 이름 확인** (Logcat에서)
   ```
   페어링된 장치: 이름=HC-06-1234, 주소=XX:XX:XX:XX:XX:XX
   ```

3. **코드에서 장치 이름 수정**
   ```java
   // MainActivity.java
   private static final String TARGET_DEVICE_NAME = "실제_장치_이름";
   ```

4. **HC-06 기본 페어링 비밀번호**: `1234` 또는 `0000`

---

### 🔴 문제: Bluetooth 연결 후 데이터 수신 없음

**증상**:
```
✅ 블루투스 연결 성공
⚠️ 블루투스 연결됨, 하지만 데이터 수신 없음
```

**원인**:
- Arduino 코드가 업로드되지 않음
- HC-06 TX/RX 핀 연결 오류
- Arduino가 데이터를 보내지 않음

**해결**:
1. **Arduino 시리얼 모니터 확인**
   - Arduino IDE → 도구 → 시리얼 모니터 (9600 baud)
   - 숫자가 계속 출력되는지 확인

2. **하드웨어 연결 확인**
   ```
   HC-06 TX  →  Arduino 핀 10 (RX)
   HC-06 RX  →  Arduino 핀 11 (TX)
   HC-06 VCC →  5V
   HC-06 GND →  GND
   ```

3. **Arduino 코드 확인**
   ```cpp
   bluetooth.println(ecgValue);  // println 사용 (줄바꿈 포함)
   ```

---

### 🔴 문제: 수신 데이터가 숫자가 아님

**증상**:
```
수신된 데이터가 숫자가 아님: [AD8232 ECG Monitor Started]
```

**원인**:
- Arduino 시작 메시지
- 잘못된 데이터 형식

**해결**:
- 시작 메시지는 자동으로 무시됨 (코드에서 처리)
- Arduino 코드에서 `println(ecgValue)` 사용 확인

---

## 3. TCP 서버 연결 문제

### 🔴 문제: TCP 서버 연결 실패

**증상**:
```
❌ TCP 연결 실패. 재시도 중...
```

**원인**:
- 서버가 실행되지 않음
- IP 주소가 잘못됨
- 방화벽 차단
- 같은 네트워크가 아님

**해결**:
1. **서버 실행 확인**
   ```bash
   cd Software/Signal_Processing
   python3 ecg_server.py
   ```
   출력:
   ```
   🫀 ECG 디지털 서명 인증 서버
   로컬 IP: 192.168.219.54
   포트: 9999
   ```

2. **Android 앱 IP 설정**
   ```java
   // MainActivity.java
   private final String PYTHON_SERVER_IP = "192.168.219.54";  // 서버 IP로 변경
   ```

3. **네트워크 확인**
   - 스마트폰과 서버가 **같은 WiFi** 연결
   - 서버 IP 확인: `ifconfig | grep "inet "`

4. **방화벽 확인**
   ```bash
   # macOS
   sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add python3
   
   # 또는 포트 열기
   sudo pfctl -d  # 방화벽 비활성화 (테스트용)
   ```

---

### 🔴 문제: 포트가 이미 사용 중

**증상**:
```
OSError: [Errno 48] Address already in use
```

**원인**:
- 이전 서버 프로세스가 종료되지 않음

**해결**:
```bash
# 포트 사용 프로세스 확인
lsof -i :9999

# 프로세스 종료
kill -9 <PID>

# 또는 한 번에
kill -9 $(lsof -t -i:9999)
```

---

## 4. ECG 데이터 품질 문제

### 🔴 문제: 베이스라인 흔들림

**증상**:
- ECG 그래프가 위아래로 천천히 흔들림
- 파형이 화면 밖으로 나감

**원인**:
- 호흡에 의한 움직임
- 전극 접촉 변화
- 땀이나 움직임

**해결**:
- 편안하게 앉아서 측정
- 전극을 단단히 부착
- 고역 통과 필터(0.5Hz)가 자동으로 제거하지만, 심한 경우 재측정

---

### 🔴 문제: 60Hz 전원 노이즈

**증상**:
- 고주파 잡음이 파형에 섞임
- 규칙적인 진동 패턴

**원인**:
- 전원선 간섭 (한국 60Hz)
- 전자기기 근처에서 측정

**해결**:
- 전자기기와 거리 두기
- Notch 필터(60Hz)가 자동으로 제거
- 접지 전극(RL) 연결 확인

---

### 🔴 문제: 근전도(EMG) 노이즈

**증상**:
- 불규칙한 고주파 잡음
- 움직일 때 특히 심함

**원인**:
- 근육 움직임
- 떨림

**해결**:
- 측정 중 움직이지 않기
- 팔을 편안하게 내려놓기
- 저역 통과 필터(45Hz)가 일부 제거

---

## 5. 인증 실패 문제

### 🔴 문제: 등록된 사용자인데 로그인 실패 (auth_failed)

**증상**:
```json
{
    "status": "auth_failed",
    "message": "ECG 인증 실패",
    "best_similarity": 0.65,
    "threshold": 0.80
}
```

**원인**:
- 측정 조건이 등록 시와 다름
- 전극 위치가 다름
- 신체 상태 변화 (운동 후, 카페인 섭취 등)
- 노이즈로 인한 특징 변화

**해결**:
1. **동일한 조건에서 재시도**
   - 같은 자세
   - 같은 전극 위치
   - 편안한 상태

2. **여러 번 시도**
   - 2-3회 시도 권장
   - 가장 좋은 조건에서 측정

3. **임계값 조정** (서버 설정)
   ```python
   # ecg_server.py
   SIMILARITY_THRESHOLD = 0.75  # 0.80 → 0.75로 낮춤
   ```

4. **추가 템플릿 등록**
   - 다양한 조건에서 여러 템플릿 등록
   - `auth_manager.py`에서 최대 5개 템플릿 유지

---

### 🔴 문제: 다른 사용자로 인증됨

**증상**:
- 본인이 아닌 다른 사용자 ID로 로그인 성공

**원인**:
- 임계값이 너무 낮음
- 등록된 ECG 데이터 품질이 낮음

**해결**:
1. **임계값 높이기**
   ```python
   SIMILARITY_THRESHOLD = 0.85  # 더 엄격하게
   ```

2. **기존 사용자 삭제 후 재등록**
   ```
   CMD:DELETE:user_id
   CMD:REGISTER:user_id
   ```

3. **좋은 품질의 ECG로 재등록**

---

## 6. Android 앱 문제

### 🔴 문제: 그래프가 표시되지 않음

**증상**:
- ECG 값은 수신되지만 그래프가 비어있음

**원인**:
- LineChart 초기화 문제
- UI 스레드 접근 오류

**해결**:
- 앱 재시작
- `initChart()` 함수 확인

---

### 🔴 문제: 진행 상태가 멈춤

**증상**:
- 데이터 수집 중 진행률이 갱신되지 않음
- 완료 후에도 진행 바가 사라지지 않음

**원인**:
- 서버 응답 처리 오류
- 모드 플래그 문제

**해결**:
- 서버 로그 확인 (응답이 전송되었는지)
- 앱 재시작
- `hideProgress()` 호출 확인

---

### 🔴 문제: 더미 데이터가 전송되지 않음

**증상**:
- 더미 데이터 버튼 클릭해도 서버에 데이터 안 감

**원인**:
- 등록/로그인 모드가 아님
- TCP 연결이 안 됨

**해결**:
1. 먼저 **TCP 서버 연결**
2. **등록 또는 로그인 버튼 클릭** (모드 활성화)
3. 더미 데이터가 자동으로 전송됨

---

## 🔍 디버깅 팁

### Logcat 필터링
```
tag:ECG_APP_CLASSIC      # Android 앱 로그
tag:ECG_TCP_CLIENT       # TCP 통신 로그
```

### Python 서버 로그
```
[연결] 클라이언트 접속: ...
[명령] REGISTER (인자: user1)
[수신] 샘플 #100, 버퍼: 100/3000
[처리] 버퍼 가득 참. 모드: register
[전송] success: 사용자 등록 완료
```

### 상태 확인 명령어
```
CMD:STATUS    # 현재 상태 확인
CMD:USERS     # 등록된 사용자 목록
```

---

## 📞 문제 해결 체크리스트

### 연결 문제
- [ ] Arduino 전원 ON
- [ ] HC-06 LED 깜빡임 확인
- [ ] Bluetooth 페어링 완료
- [ ] Python 서버 실행 중
- [ ] 같은 WiFi 네트워크

### 데이터 문제
- [ ] Arduino 시리얼 모니터에서 숫자 출력 확인
- [ ] 전극 3개 모두 부착
- [ ] 전극 젤 상태 양호
- [ ] 움직이지 않고 측정

### 인증 문제
- [ ] 등록 시와 같은 조건
- [ ] 신호 품질 60점 이상
- [ ] R-peak 3개 이상 검출
- [ ] 유사도 80% 이상

---

*문제가 지속되면 서버 로그와 Logcat 내용을 함께 확인해주세요.*






