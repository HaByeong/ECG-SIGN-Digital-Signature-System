# 🫀 ECG-SIGN 디지털 서명 시스템 - 최종 프로젝트 보고서

---

## 1️⃣ Target (목표): 어떤 종류의 시스템을 설계했는가?

### 시스템 개요
**ECG(심전도) 파형의 형태학적 특징을 기반으로 개인을 식별하는 2차 인증 디지털 서명 시스템**

### 시스템 구성
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  하드웨어    │ ──▶ │ Android 앱  │ ──▶ │ Python 서버 │ ──▶ │   인증 결과  │
│ AD8232+     │ BT  │ 데이터 수집  │ TCP │ ECG 처리    │     │ 성공/실패   │
│ Arduino+    │     │ + 시각화    │     │ 파이프라인   │     │            │
│ HC-06+LCD   │     │             │     │             │     │            │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 핵심 기능
| 기능 | 설명 | 기술 |
|------|------|------|
| **ECG 수집** | AD8232 센서로 500Hz 샘플링 | Arduino, SoftwareSerial |
| **실시간 표시** | LCD에 ECG 값 및 범위 표시 | I2C LCD (16x2) |
| **R-peak 검출** | 심박 위치 자동 검출 | Pan-Tompkins 알고리즘 |
| **특징 추출** | 형태학적/시간/주파수/통계적 특징 | NumPy, SciPy |
| **서명 생성** | 해시 기반 디지털 서명 | SHA-256 |
| **인증** | 엄격한 유사도 비교 | 하이브리드 알고리즘 |

### 기술 스택
| 영역 | 기술 |
|------|------|
| **Hardware** | Arduino UNO, AD8232 ECG 센서, HC-06 Bluetooth, I2C LCD |
| **Android** | Java, Bluetooth SPP, TCP Socket, MPAndroidChart |
| **Server** | Python 3, NumPy, SciPy, TCP Socket |
| **Algorithm** | Pan-Tompkins, Butterworth Filter, SHA-256, Hybrid Similarity |

---

## 2️⃣ Motivation (동기): 왜 이 시스템이 필요한가?

### 기존 생체 인증의 한계

| 인증 방식 | 장점 | 단점 |
|----------|------|------|
| **지문** | 보편화, 빠름 | ❌ 복제 가능 (실리콘, 사진) |
| **얼굴** | 비접촉 | ❌ 사진/영상으로 우회 가능 |
| **홍채** | 정확도 높음 | ❌ 고가 장비 필요 |
| **ECG** | ✅ 살아있는 사람만 가능 | 전극 부착 필요 |

### ECG 인증의 핵심 장점

1. **생체 여부 자동 확인** 
   - 심장이 뛰어야만 신호 발생
   - 사망자, 마네킹, 사진 등 불가

2. **복제 불가능**
   - 실시간 생체 신호
   - 녹화/재생 공격 불가

3. **개인 고유성**
   - P-QRS-T 파형의 형태와 간격이 개인마다 다름
   - 심장의 물리적 구조 반영

4. **지속 인증 가능성**
   - 웨어러블 기기로 연속 모니터링
   - 스마트워치, 피트니스 밴드 확장 가능

### 적용 시나리오
- 🏦 금융: 고액 거래 시 2차 인증
- 🏥 의료: 환자 본인 확인, 의료 기록 접근
- 🔐 보안 시설: 출입 통제
- 💻 디지털: 전자 서명, 계약

---

## 3️⃣ Problem / Challenge (문제/과제)

### A. 프로젝트 정의 시 예상한 문제점

| 문제 | 설명 | 해결 방향 |
|------|------|----------|
| **ECG 신호 변동성** | 같은 사람도 측정 시점마다 신호가 다름 | 정규화 + 다중 특징 추출 |
| **노이즈** | 전원(60Hz), 근전도, 베이스라인 흔들림 | 디지털 필터링 파이프라인 |
| **실시간 처리** | 500Hz 데이터 스트리밍 | 버퍼링 + 비동기 처리 |
| **인증 정확도** | FAR/FRR 균형 | 하이브리드 유사도, 적응형 임계값 |

### B. 프로젝트 진행 중 겪은 실제 어려움

---

#### 🔴 트러블슈팅 #1: 블루투스 연결은 되는데 데이터 전송 안됨

**증상**: 
- Android 앱에서 "✅ 블루투스 연결 성공" 메시지 표시
- 하지만 ECG 데이터가 수신되지 않음
- Arduino 시리얼 모니터에서는 데이터 정상 출력

**원인 분석**:
```
휴대폰 ←── 블루투스 RF 연결 ──→ HC-06 ←── UART TX/RX ──✖ Arduino
           (이 부분은 정상)              (이 부분이 문제)
```

HC-06 모듈은 두 개의 독립적인 부분으로 구성:
- **블루투스 RF 부분**: 휴대폰과 무선 연결 (정상)
- **UART 시리얼 부분**: Arduino와 유선 연결 (문제)

**해결책**:
1. TX/RX 핀 교차 연결 확인
   ```
   HC-06 TX → Arduino 10번 (RX)
   HC-06 RX → Arduino 11번 (TX)
   ```
2. 테스트 코드로 블루투스 전송 확인:
   ```cpp
   void loop() {
     bluetooth.println("TEST");
     delay(1000);
   }
   ```

---

#### 🔴 트러블슈팅 #2: HC-06 모듈 TX 핀 고장 의심

**증상**:
- TX/RX 핀을 올바르게 연결해도 데이터 전송 안됨
- 블루투스 연결은 계속 성공

**원인 분석**:
- HC-06 모듈의 블루투스 RF 칩은 정상 작동
- UART TX 핀이 물리적으로 고장
- 연결은 되지만 데이터 출력 불가

**해결책**:
1. 테스트 코드로 전송 확인
2. 핀 연결 재확인
3. 모듈 교체 (새 HC-06 구입)

**배운 점**:
> "블루투스 연결 성공 ≠ 데이터 전송 가능"
> RF 부분과 UART 부분은 독립적으로 고장날 수 있음

---

#### 🔴 트러블슈팅 #3: 다른 사람 ECG로도 인증 성공 (보안 취약점)

**증상**:
- 본인 ECG로 등록
- **다른 사람** ECG로 로그인 시도 → 인증 성공 😱
- 유사도가 85% 이상으로 나옴

**원인 분석**:
```python
# 기존 코드 문제점
scale = 15.0  # 너무 관대! → 다른 사람도 유사하게 나옴

# Z-score 정규화가 개인 특성 제거
v1_normalized = (v1 - np.mean(v1)) / np.std(v1)
# → 모든 벡터가 평균=0, 표준편차=1로 변환
# → 개인 간 절대값 차이가 사라짐
```

**해결책**:
1. **유사도 알고리즘 강화**:
   ```python
   # 새로운 하이브리드 유사도
   유사도 = 0.30 × 원본값차이      # 개인 특성 보존
          + 0.25 × 코사인유사도    # 패턴 형태
          + 0.20 × 유클리드유사도  # 정규화 후 거리
          + 0.25 × 핵심특징유사도  # 형태학적 특징
   ```

2. **scale 값 조정**: 15.0 → 5.0 (엄격하게)

3. **임계값 상향**: 0.80 → 0.85

4. **원본 값 비교 추가**: Z-score 정규화 전 원본 값 차이도 반영

---

#### 🔴 트러블슈팅 #4: 파이프라인 실패 시 불완전한 등록

**증상**:
- R-peak 검출 실패해도 `status: "success"` 반환
- 형태학적 특징 없이 단순 통계값으로 등록
- 이후 로그인 시 인증 정확도 저하

**원인**:
```python
# 기존 코드 - 폴백으로 성공 처리
except Exception as e:
    return self._process_basic(ecg_data)  # 불완전 데이터로 등록!
```

**해결책**:
```python
# 수정 코드 - 명확한 에러 반환
except Exception as e:
    return {
        "status": "error",
        "message": f"파이프라인 처리 실패: {e}"
    }
```

---

#### 🔴 트러블슈팅 #5: R-peak 검출 부족

**증상**:
```json
{
    "status": "insufficient_peaks",
    "message": "R-peak가 부족합니다. 검출: 2개/3개 필요"
}
```

**원인**:
- ECG 신호 품질 낮음
- 전극 접촉 불량
- 측정 시간 부족 (심박이 느린 경우)

**해결책**:
1. 전극 재부착 및 상태 확인
2. 측정 시간 연장 (6초 → 8초)
3. 적응형 임계값 개선

---

#### 🔴 트러블슈팅 #6: 9600 baud 대역폭 한계

**증상**:
- 500Hz 샘플링 시 데이터 손실
- 블루투스 전송 속도가 샘플링 속도를 못 따라감

**원인**:
```
필요 대역폭: 500 × 6바이트 = 3000바이트/초
9600 baud: 약 960바이트/초 (부족!)
```

**해결책**:
1. HC-06 보드레이트 변경: 9600 → 57600 (AT+BAUD7)
2. 또는 샘플링 레이트 감소: 500Hz → 250Hz

---

#### 🔴 트러블슈팅 #7: LCD 라이브러리 설치 오류

**증상**:
```
fatal error: LiquidCrystal_I2C.h: No such file or directory
```

**해결책**:
1. Arduino IDE → 라이브러리 관리자
2. "LiquidCrystal I2C" 검색
3. 설치 또는 ZIP 파일 수동 설치
4. Arduino IDE 재시작

---

#### 🔴 트러블슈팅 #8: PyCharm 설정 오류

**증상**:
```
Configuration is still incorrect. Do you want to edit it again?
```

**원인**: Python 인터프리터 미설정

**해결책**:
1. Settings → Python Interpreter → Add
2. System Interpreter 선택
3. 또는 터미널에서 직접 실행: `python3 ecg_server.py`

---

## 4️⃣ Solution (해결책) 요약

### 하드웨어 문제 해결

| 문제 | 해결책 |
|------|--------|
| TX/RX 연결 오류 | 교차 연결 확인 (TX→RX, RX→TX) |
| 모듈 고장 | 테스트 코드로 확인 후 교체 |
| 대역폭 부족 | 보드레이트 상향 (57600) |

### 소프트웨어 문제 해결

| 문제 | 해결책 |
|------|--------|
| 인증 정확도 낮음 | 하이브리드 유사도 알고리즘 강화 |
| 폴백 처리 문제 | 명확한 에러 반환 |
| R-peak 부족 | 측정 시간 연장, 품질 검증 추가 |

### 최종 유사도 알고리즘
```python
hybrid_similarity = (
    0.30 * raw_similarity +      # 원본 값 차이 (개인 특성 보존)
    0.25 * cosine_sim +          # 패턴 형태
    0.20 * euclidean_sim +       # 정규화 후 거리
    0.25 * core_similarity       # 핵심 특징 (형태학적)
)
```

---

## 5️⃣ Lessons Learned (배운 점)

### 기술적 배운 점

| 영역 | 배운 점 |
|------|---------|
| **신호 처리** | Butterworth 필터, Pan-Tompkins 알고리즘 실제 구현 |
| **하드웨어** | SoftwareSerial TX/RX 교차 연결의 중요성 |
| **블루투스** | RF 연결 ≠ 데이터 전송 (독립적 구성요소) |
| **에러 처리** | 폴백 처리의 위험성 (불완전한 성공 < 명확한 실패) |
| **인증 시스템** | FAR/FRR 트레이드오프, 다중 특징 비교의 중요성 |
| **정규화** | Z-score만 사용하면 개인 특성이 사라질 수 있음 |

### 프로젝트 관리 배운 점

1. **단계별 검증의 중요성**
   - Arduino → 시리얼 모니터 확인
   - 블루투스 → 테스트 코드로 확인
   - 서버 → 로그 출력으로 확인
   - 각 단계를 독립적으로 테스트

2. **트러블슈팅 문서화**
   - 겪은 문제와 해결책을 기록
   - 같은 문제 재발 시 빠르게 대응

3. **하드웨어 vs 소프트웨어**
   - 코드가 맞아도 하드웨어 연결이 틀리면 작동 안함
   - 물리적 연결 상태도 항상 확인

---

## 6️⃣ Role per Member (팀원별 역할)

### 전체 시스템 설계 및 구현

| 역할 | 담당 내용 | 비중 |
|------|----------|------|
| **하드웨어** | Arduino + AD8232 + HC-06 + LCD 연결 | 20% |
| **Android 앱** | Bluetooth/TCP 통신, UI, 그래프 | 25% |
| **Python 서버** | ECG 처리 파이프라인, 인증 로직 | 35% |
| **알고리즘** | 유사도 계산, 특징 추출 개선 | 10% |
| **문서화/테스트** | 보고서, 트러블슈팅 가이드 | 10% |

### 구현 모듈
```
📁 Hardware/
   └── main.ino              ← ECG + Bluetooth + LCD

📁 Android_App/
   └── MainActivity.java     ← UI + 통신 + 그래프

📁 Signal_Processing/
   ├── ecg_server.py         ← TCP 서버
   └── ecg_processor/
       ├── preprocessing.py      ← 필터링
       ├── r_peak_detector.py    ← Pan-Tompkins
       ├── beat_processor.py     ← 비트 처리
       ├── feature_extractor.py  ← 특징 추출 (37개+)
       ├── signature_generator.py ← SHA-256 서명
       ├── pipeline.py           ← 통합 파이프라인
       └── auth_manager.py       ← 인증 관리 (수정됨)
```

---

## 📊 최종 성과 요약

| 항목 | 결과 |
|------|------|
| **샘플링 레이트** | 500 Hz |
| **수집 시간** | 6초 (3000 샘플) |
| **처리 시간** | < 1초 |
| **특징 수** | 37개+ (4개 도메인) |
| **인증 임계값** | 85% (하이브리드 유사도) |
| **서명 길이** | 64자 (SHA-256) |

---

## 🔑 핵심 메시지

> "ECG 파형에서 **Pan-Tompkins 알고리즘**으로 심박을 찾고, **30개 이상의 형태학적·시간·주파수·통계 특징**을 추출해 **SHA-256 해시**로 변환한 뒤, **엄격한 하이브리드 유사도 알고리즘**으로 본인 여부를 판단하는 **2차 인증 시스템**"

---

## 📚 참고 문헌

1. Pan, J., & Tompkins, W. J. (1985). "A Real-Time QRS Detection Algorithm". IEEE Transactions on Biomedical Engineering.
2. Odinaka, I., et al. (2012). "ECG Biometric Recognition: A Comparative Analysis". IEEE Access.

---

*작성일: 2025-12-13*

